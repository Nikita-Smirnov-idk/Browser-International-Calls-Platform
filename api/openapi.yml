openapi: 3.0.3
info:
  title: Browser International Calls Platform API
  description: |
    Backend API для платформы международных звонков через браузер.
    Обеспечивает аутентификацию пользователей, инициализацию звонков,
    хранение истории и взаимодействие с VoIP/WebRTC-сервисом.
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Auth
    description: Аутентификация и управление сессией
  - name: Calls
    description: Управление звонками
  - name: History
    description: История звонков
  - name: System
    description: Системные проверки

paths:

  /auth/register:
    post:
      tags: [Auth]
      summary: Регистрация пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Пользователь успешно зарегистрирован
        "400":
          description: Некорректные данные
        "409":
          description: Пользователь уже существует

  /auth/login:
    post:
      tags: [Auth]
      summary: Вход пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Успешная аутентификация
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Неверные учетные данные

  /auth/logout:
    post:
      tags: [Auth]
      summary: Выход пользователя
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Успешный выход

  /calls/initiate:
    post:
      tags: [Calls]
      summary: Инициация звонка через WebRTC
      description: |
        Создает запись звонка, инициирует VoIP сессию и возвращает параметры для установки WebRTC-соединения.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InitiateCallRequest"
      responses:
        "200":
          description: Звонок инициирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InitiateCallResponse"
        "400":
          description: Некорректные данные
        "401":
          description: Неавторизован
        "503":
          description: VoIP сервис недоступен

  /calls/terminate:
    post:
      tags: [Calls]
      summary: Завершение звонка через WebRTC
      description: |
        Завершает активный звонок, закрывает VoIP сессию и обновляет длительность в базе данных.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TerminateCallRequest"
      responses:
        "200":
          description: Звонок завершен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TerminateCallResponse"
        "400":
          description: Некорректные данные
        "401":
          description: Неавторизован
        "403":
          description: Нет прав доступа к этому звонку
        "404":
          description: Звонок не найден

  /calls/start:
    post:
      tags: [Calls]
      summary: Инициация звонка (устаревший endpoint)
      deprecated: true
      description: |
        Создает запись звонка и возвращает параметры для установки WebRTC-соединения.
        Используйте /calls/initiate вместо этого endpoint.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartCallRequest"
      responses:
        "200":
          description: Звонок инициирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartCallResponse"
        "400":
          description: Некорректные данные
        "401":
          description: Неавторизован

  /calls/end:
    post:
      tags: [Calls]
      summary: Завершение звонка (устаревший endpoint)
      deprecated: true
      description: |
        Используйте /calls/terminate вместо этого endpoint.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EndCallRequest"
      responses:
        "200":
          description: Звонок завершен
        "404":
          description: Звонок не найден

  /calls/history:
    get:
      tags: [History]
      summary: Получение истории звонков
      security:
        - bearerAuth: []
      responses:
        "200":
          description: История звонков пользователя
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CallHistoryItem"

  /system/health:
    get:
      tags: [System]
      summary: Проверка состояния сервиса
      responses:
        "200":
          description: Сервис доступен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    AuthResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: JWT токен доступа

    InitiateCallRequest:
      type: object
      required: [phone_number]
      properties:
        phone_number:
          type: string
          description: Номер телефона в международном формате
          example: "+491512345678"

    InitiateCallResponse:
      type: object
      properties:
        call_id:
          type: string
          description: Уникальный идентификатор звонка
        session_id:
          type: string
          description: Идентификатор VoIP сессии
        sdp_offer:
          type: string
          description: SDP offer для установки WebRTC соединения
        status:
          type: string
          enum: [connecting, active]
          description: Текущий статус звонка
        start_time:
          type: string
          format: date-time
          description: Время начала звонка

    TerminateCallRequest:
      type: object
      required: [call_id]
      properties:
        call_id:
          type: string
          description: Уникальный идентификатор звонка

    TerminateCallResponse:
      type: object
      properties:
        call_id:
          type: string
          description: Уникальный идентификатор звонка
        duration:
          type: integer
          description: Длительность звонка в секундах
        status:
          type: string
          enum: [completed]
          description: Финальный статус звонка

    StartCallRequest:
      type: object
      required: [countryCode, phoneNumber]
      properties:
        countryCode:
          type: string
          example: "+49"
        phoneNumber:
          type: string
          example: "15123456789"

    StartCallResponse:
      type: object
      properties:
        callId:
          type: string
        rtcConfig:
          type: object
          description: |
            Параметры для установки WebRTC-соединения
          additionalProperties: true

    EndCallRequest:
      type: object
      required: [callId]
      properties:
        callId:
          type: string

    CallHistoryItem:
      type: object
      properties:
        callId:
          type: string
        phoneNumber:
          type: string
        startedAt:
          type: string
          format: date-time
        durationSeconds:
          type: integer
        status:
          type: string
          enum: [completed, failed, canceled]

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
